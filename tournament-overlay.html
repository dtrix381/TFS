<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tournament Overlay</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: black;
      font-family: 'Orbitron', sans-serif;
      color: white;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
.gold-frame {
  width: 1600px;
  height: 400px;
  border: 5px solid gold;
  border-radius: 20px;
  box-shadow: 0 0 30px gold;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0, 0, 0, 0.8);
  position: relative;
  overflow: hidden; /* ‚úÖ Ensures slides stay within container */
}

.slide {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  opacity: 0;
  transition: opacity 1s ease-in-out;
  padding: 0; /* Make sure there's no space preventing full height */
}

.slide.active {
  opacity: 1;
}

    .slide h1, .slide h2, .slide h3 {
      margin-bottom: 10px;
    }
    .bracket {
      margin-top: 10px;
    }
    .highlight {
      color: gold;
      font-weight: bold;
    }

.tournament-title {
  font-family: 'Orbitron', sans-serif;
  font-size: 64px;
  font-weight: 900;
  color: #00fff7;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 20px;

  /* Glow + flicker */
  text-shadow:
    0 0 3px #00fff7,
    0 0 6px #00fff7,
    0 0 9px #00fff7,
    0 0 12px #00fff7;

  /* Outline effect */
  -webkit-text-stroke: 2px #00fff7;

  animation: flicker 2.5s infinite alternate;
}

@keyframes flicker {
  0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
    opacity: 1;
  }
  20%, 24%, 55% {
    opacity: 0.5;
  }
}

.player-slide {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
}

.player-slide h2 {
  font-size: 36px;
  color: gold;
  text-shadow: 0 0 5px gold;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.player-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 5px;
  width: 100%;          /* Just a little gap to gold-frame edge */
  height: 95%;         /* Fill vertical space nicely */
  padding: 5px;
  box-sizing: border-box;
}

.player-card {
  background: rgba(255, 215, 0, 0.1);
  border: 2px solid gold;
  border-radius: 12px;
  color: white;
  font-family: 'Orbitron', sans-serif;
  box-shadow: 0 0 10px gold;

  /* Fixed size using grid cell */
  width: 100%;
  height: 100%;

  /* Center text */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  /* Prevent overflow */
  overflow: hidden;
  text-align: center;
  padding: 12px;
}

.player-card .name {
  font-size: 28px;
  font-weight: bold;
  color: #00fff7;
  text-shadow: 0 0 5px #00fff7;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 90%;
}

.player-card .slot {
  font-size: 20px;
  opacity: 0.9;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 90%;
}




  </style>
</head>
<body>
  <div class="gold-frame">
    <div id="slides"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGCiv3p9KgjXR7yCA8Z2JYMhPweDRnQPk",
      authDomain: "tfs-hunt-tracker.firebaseapp.com",
      projectId: "tfs-hunt-tracker"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("user");
    const slidesContainer = document.getElementById("slides");

    let slideIndex = 0;
    let slideData = [];

    function renderSlides(data) {
  slideData = [];

  const title = data.title || "Tournament";
  const players = data.players || [];
  const roundsRaw = data.rounds || [];

  const rounds = roundsRaw.map((roundObj) => {
    if (Array.isArray(roundObj)) return roundObj;
    const matches = [];
    const keys = Object.keys(roundObj).filter(k => k.startsWith("match"));
    keys.sort((a, b) => parseInt(a.replace("match", "")) - parseInt(b.replace("match", "")));
    for (const key of keys) {
      const match = roundObj[key];
      if (match) matches.push([match.p1 || null, match.p2 || null, match.result || null]);
    }
    return matches;
  });

  // 1. Current match-up
  const currentMatch = rounds[0]?.find(m => !m[2] && m[0] && m[1]);
  if (currentMatch) {
    slideData.push(`<div><h1>Current Match-up</h1><h2>${currentMatch[0].kickUsername} vs ${currentMatch[1].kickUsername}</h2></div>`);
  }

  // 2. Title
  slideData.push(`<div><h1 class="tournament-title">${title}</h1></div>`);


  // 3. Players 1-4
  if (players.length >= 1) {
  const chunk1 = players.slice(0, 4);
  const html = `
    <div class="player-slide">
      <h2>Players</h2>
      <div class="player-grid">
        ${chunk1.map(p => `
          <div class="player-card">
            <div class="name">${p.kickUsername}</div>
            <div class="slot">${p.slot}</div>
          </div>
        `).join("")}
      </div>
    </div>
  `;
  slideData.push(html);
}

  // 4. Players 5-8
  if (players.length > 4) {
  const chunk2 = players.slice(4, 8);
  const html = `
    <div class="player-slide">
      <h2>Players</h2>
      <div class="player-grid">
        ${chunk2.map(p => `
          <div class="player-card">
            <div class="name">${p.kickUsername}</div>
            <div class="slot">${p.slot}</div>
          </div>
        `).join("")}
      </div>
    </div>
  `;
  slideData.push(html);
}

  // 5. Brackets
  const bracketNames = ["1A", "1B", "1C", "1D", "2A", "2B", "3A"];
  let bracketCount = 0;
  rounds.forEach((round, rIdx) => {
    round.forEach((match, mIdx) => {
      const p1 = match[0];
      const p2 = match[1];
      const result = match[2];
      if (p1 && p2) {
        const code = bracketNames[bracketCount++] || `R${rIdx + 1}M${mIdx + 1}`;
        const winner = result?.winner?.kickUsername;
        const line1 = winner === p1.kickUsername ? `<span class='highlight'>${p1.kickUsername}</span>` : p1.kickUsername;
        const line2 = winner === p2.kickUsername ? `<span class='highlight'>${p2.kickUsername}</span>` : p2.kickUsername;
        slideData.push(`<div><h2>Bracket ${code}</h2><div class='bracket'>${line1} vs ${line2}</div></div>`);
      }
    });
  });

  // 6. Champion
  const final = rounds[2]?.[0];
  if (final && final[2] && final[2].winner) {
    slideData.push(`<div><h1>üèÜ Champion</h1><h2>${final[2].winner.kickUsername}</h2></div>`);
  }

  renderNextSlide();
}


    function renderNextSlide() {
      slidesContainer.innerHTML = slideData
        .map((html, i) => `<div class="slide ${i === slideIndex ? 'active' : ''}">${html}</div>`)
        .join("");
    }

    function nextSlide() {
      if (slideData.length === 0) return;
      slideIndex = (slideIndex + 1) % slideData.length;
      renderNextSlide();
    }

    function fetchAndRender() {
      if (!userId) return;
      db.collection("tournaments").doc(userId).get().then(doc => {
        if (doc.exists) {
          renderSlides(doc.data());
        }
      });
    }

    setInterval(fetchAndRender, 5000); // Refresh every 5s
    setInterval(nextSlide, 3000);      // Change slide every 3s
    fetchAndRender(); // Initial load
  </script>
</body>
</html>
