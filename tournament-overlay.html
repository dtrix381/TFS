<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tournament Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Orbitron', sans-serif;
    }

    body {
      background: black;
      color: white;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .slider {
      width: 90vw;
      height: 25vh;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .slide {
      position: absolute;
      opacity: 0;
      transition: opacity 0.6s ease-in-out;
      text-align: center;
      font-size: 1.6rem;
      width: 100%;
    }

    .slide.active {
      opacity: 1;
    }

    .highlight {
      color: #00ff00;
      font-weight: bold;
    }

    .bracket {
      display: flex;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="slider" id="slider"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGCiv3p9KgjXR7yCA8Z2JYMhPweDRnQPk",
      authDomain: "tfs-hunt-tracker.firebaseapp.com",
      projectId: "tfs-hunt-tracker"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("user");
    const slider = document.getElementById("slider");
    let slides = [];
    let currentIndex = 0;

    async function fetchTournamentData() {
      if (!userId) return;
      const doc = await db.collection("tournaments").doc(userId).get();
      if (!doc.exists) return;

      const data = doc.data();
      const players = data.players || [];
      const title = data.title || "Tournament";
      const rounds = (data.rounds || []).map(roundObj => {
        return Object.values(roundObj).map(match => {
          return [match.p1, match.p2, match.result];
        });
      });

      slides = [];

      // 1. Current Matchup (30s)
      const current = rounds.flat().find(match => match[0] && match[1] && !match[2]);
      if (current) {
        slides.push({
          html: `<div><h1>üéØ Current Match-Up</h1><br>${current[0].kickUsername} vs ${current[1].kickUsername}</div>`,
          duration: 30000
        });
      }

      // 2. Tournament Title
      slides.push({ html: `<div><h1>${title}</h1></div>`, duration: 3000 });

      // 3. Players (first 4)
      slides.push({
        html: `<div><h2>üë• Players</h2><div class="bracket">${players.slice(0, 4).map(p => `<div>${p.kickUsername}</div>`).join('')}</div></div>`,
        duration: 3000
      });

      // 4. Players (last 4)
      slides.push({
        html: `<div><h2>üë• Players</h2><div class="bracket">${players.slice(4).map(p => `<div>${p.kickUsername}</div>`).join('')}</div></div>`,
        duration: 3000
      });

      // 5. Brackets (1A to 3A)
      const bracketLabels = ["1A", "1B", "1C", "1D", "2A", "2B", "3A"];
      rounds.flat().forEach((match, idx) => {
        if (match[0] && match[1]) {
          const label = bracketLabels[idx] || `Bracket ${idx + 1}`;
          const winner = match[2]?.winner?.kickUsername;
          const p1 = match[0].kickUsername;
          const p2 = match[1].kickUsername;
          slides.push({
            html: `<div><h2>${label}</h2>${p1} ${winner === p1 ? '<span class="highlight">(Winner)</span>' : ''} vs ${p2} ${winner === p2 ? '<span class="highlight">(Winner)</span>' : ''}</div>`,
            duration: 3000
          });
        }
      });

      // 6. Champion
      const final = rounds[2]?.[0];
      if (final && final[2] && final[2].winner) {
        slides.push({ html: `<div><h1>üèÜ Champion: ${final[2].winner.kickUsername}</h1></div>`, duration: 3000 });
      }

      runSlider();
    }

    function runSlider() {
      if (slides.length === 0) return;
      slider.innerHTML = slides.map((s, i) => `<div class="slide${i === 0 ? ' active' : ''}">${s.html}</div>`).join("");
      currentIndex = 0;

      setInterval(() => {
        const allSlides = document.querySelectorAll(".slide");
        allSlides[currentIndex].classList.remove("active");
        currentIndex = (currentIndex + 1) % slides.length;
        allSlides[currentIndex].classList.add("active");
      }, slides[currentIndex].duration);
    }

    fetchTournamentData();
    setInterval(fetchTournamentData, 5000); // Auto-refresh overlay every 5 seconds
  </script>
</body>
</html>
