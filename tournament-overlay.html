<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tournament Overlay</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Orbitron', sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .overlay-container {
      width: 95vw;
      height: 15vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .slide {
      display: none;
      font-size: 1.5rem;
      padding: 10px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      text-align: center;
      animation: fade 0.6s ease-in-out;
    }
    .slide.active {
      display: block;
    }
    .winner {
      color: #0f0;
      font-weight: bold;
    }
    @keyframes fade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="overlay-container">
    <div id="slides"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGCiv3p9KgjXR7yCA8Z2JYMhPweDRnQPk",
      authDomain: "tfs-hunt-tracker.firebaseapp.com",
      projectId: "tfs-hunt-tracker"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const userId = new URLSearchParams(window.location.search).get('user');
    const slidesContainer = document.getElementById('slides');

    function createSlide(text) {
      const div = document.createElement('div');
      div.className = 'slide';
      div.innerHTML = text;
      return div;
    }

    let allSlides = [];
    let slideIndex = 0;
    let slideInterval;

    function updateSlides(data) {
      allSlides = [];
      const { title, players = [], rounds = [] } = data;

      if (!title) return;

      // 1. Current Match (30s)
      const current = findCurrentMatch(rounds);
      if (current) {
        const [p1, p2] = current;
        allSlides.push(createSlide(`ğŸ¯ CURRENT MATCH-UP:<br><strong>${p1.kickUsername}</strong> vs <strong>${p2.kickUsername}</strong>`));
      }

      // 2. Tournament Title
      allSlides.push(createSlide(`ğŸ† TOURNAMENT TITLE:<br>${title}`));

      // 3 & 4. Players
      if (players.length) {
        allSlides.push(createSlide(`ğŸ® PLAYERS:<br>${players.slice(0, 4).map(p => p.kickUsername).join(' | ')}`));
        if (players.length > 4) {
          allSlides.push(createSlide(`ğŸ® PLAYERS:<br>${players.slice(4, 8).map(p => p.kickUsername).join(' | ')}`));
        }
      }

      // 5. Brackets with complete data
      rounds.forEach((round, rIdx) => {
        round.forEach((match, mIdx) => {
          if (!match[0] || !match[1]) return; // skip if incomplete
          const p1 = match[0].kickUsername;
          const p2 = match[1].kickUsername;
          const result = match[2];
          const code = `${rIdx + 1}${String.fromCharCode(65 + mIdx)}`;

          if (result?.winner) {
            const winner = result.winner.kickUsername;
            const highlight = (name) => name === winner ? `<span class="winner">${name}</span>` : name;
            allSlides.push(createSlide(`ğŸ¯ ${code}: ${highlight(p1)} vs ${highlight(p2)}`));
          } else {
            allSlides.push(createSlide(`ğŸ¯ ${code}: ${p1} vs ${p2}`));
          }
        });
      });

      // 6. Champion
      const final = rounds[2]?.[0];
      if (final?.[2]?.winner) {
        allSlides.push(createSlide(`ğŸ‘‘ CHAMPION:<br><span class="winner">${final[2].winner.kickUsername}</span>`));
      }

      // Display and cycle
      slidesContainer.innerHTML = '';
      allSlides.forEach(slide => slidesContainer.appendChild(slide));
      startSlider();
    }

    function startSlider() {
      const all = document.querySelectorAll('.slide');
      if (!all.length) return;
      clearInterval(slideInterval);
      slideIndex = 0;
      all.forEach(s => s.classList.remove('active'));
      all[slideIndex].classList.add('active');

      slideInterval = setInterval(() => {
        all[slideIndex].classList.remove('active');
        slideIndex = (slideIndex + 1) % all.length;
        all[slideIndex].classList.add('active');
      }, slideIndex === 0 ? 30000 : 3000); // 30s for current, 3s for others
    }

    function findCurrentMatch(rounds) {
      for (const round of rounds) {
        for (const match of round) {
          if (match[0] && match[1] && !match[2]) {
            return [match[0], match[1]];
          }
        }
      }
      return null;
    }

    if (userId) {
      db.collection("tournaments").doc(userId).onSnapshot(doc => {
        if (doc.exists) {
          updateSlides(doc.data());
        }
      });
    }
  </script>
</body>
</html>
